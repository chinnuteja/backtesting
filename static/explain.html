<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Explanation — portfolio_enhancer</title>
  <style>
    :root{
      --bg1:#0b1220; --bg2:#0b1220; --text:#e5e7eb; --muted:#9ca3af; --border:rgba(255,255,255,.12);
      --card:rgba(255,255,255,.06); --chip:rgba(255,255,255,.1);
      --indigo:#818cf8; --emerald:#34d399; --rose:#f87171;
      --shadow:0 8px 24px rgba(0,0,0,.25),0 2px 6px rgba(0,0,0,.2);
    }
    *{box-sizing:border-box}
    /* The missing piece: hide utility */
    .hidden{display:none !important;}

    body{margin:0;background:linear-gradient(140deg,var(--bg1),var(--bg2));color:var(--text);font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;min-height:100vh}
    .container{max-width:1100px;margin:0 auto;padding:24px}
    h1{font-size:clamp(26px,4vw,36px);margin:0;font-weight:800}
    h2{font-size:22px;margin:0 0 16px;font-weight:700}
    h3{font-size:16px;margin:0 0 8px;font-weight:700}
    .muted{color:var(--muted)}
    .card{background:var(--card);backdrop-filter:blur(6px);border:1px solid var(--border);border-radius:24px;padding:24px;box-shadow:var(--shadow)}
    .chip{font-size:12px;color:#cbd5e1;background:var(--chip);border:1px solid var(--border);padding:4px 10px;border-radius:999px}
    .grid{display:grid;gap:16px}
    @media (min-width:640px){.grid-2{grid-template-columns:repeat(2,1fr)}}
    @media (min-width:1024px){.grid-4{grid-template-columns:repeat(4,1fr)} .grid-3{grid-template-columns:1fr 1fr 1fr}}
    .error{background:rgba(239,68,68,.18);border:1px solid rgba(248,113,113,.7);color:#ffecec;padding:12px;border-radius:16px}
    .btn{display:inline-block;background:#10b981;color:#041016;font-weight:700;padding:10px 14px;border-radius:10px;border:0;cursor:pointer}
    .tile{border:1px solid var(--border);border-radius:16px;padding:14px;background:var(--card)}
    .tile .title{font-weight:700}
    .row{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid var(--border)}
    .row:last-child{border-bottom:0}
  </style>
</head>
<body>
  <div class="container">
    <header class="card" style="margin-bottom:16px">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
        <h1>Explanation</h1>
        <span id="asof" class="chip"></span>
      </div>
    </header>

    <!-- LOADING (visible only before we have data) -->
    <div id="loading" class="card" style="text-align:center">
      <div style="width:56px;height:56px;border-radius:999px;border:5px solid #a5b4fc;border-right-color:transparent;margin:0 auto;animation:spin 1s linear infinite"></div>
      <p class="muted" style="margin-top:10px">Generating explanation…</p>
    </div>

    <!-- ERROR -->
    <div id="error" class="hidden error" style="margin:16px 0 0"></div>

    <!-- CARDS + ANALYSIS (hidden until render) -->
    <section id="cards" class="hidden grid grid-4" style="margin:16px 0"></section>

    <section id="analysis" class="hidden card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
        <h2 id="asset-title">Asset Class Analysis</h2>
        <div id="asset-alloc" style="font-size:22px;font-weight:800"></div>
      </div>

      <div class="grid grid-3" style="align-items:start">
        <!-- Left stacked: Historical + Risk -->
        <div class="grid" style="order:2">
          <div class="tile">
            <h3 class="title" style="margin-bottom:6px">Historical Returns</h3>
            <div id="hist"></div>
          </div>
          <div class="tile">
            <h3 class="title" style="margin-bottom:6px">Risk Metrics</h3>
            <div id="risk"></div>
          </div>
        </div>

        <!-- Indicators (two columns span) -->
        <div class="tile" style="order:1;grid-column:span 2">
          <h3 class="title" style="margin-bottom:6px">Key Indicators</h3>
          <div id="indicators"></div>
        </div>
      </div>

      <div class="tile" style="margin-top:16px">
        <p id="asset-expl" class="muted"></p>
      </div>
    </section>

    <section id="rationale-wrap" class="hidden card" style="margin-top:16px">
      <h3 class="title" style="margin-bottom:6px">Portfolio Rationale</h3>
      <p id="rationale" class="muted"></p>
    </section>
  </div>

  <script>
    // simple keyframes for spinner
    (function(){const s=document.createElement('style');s.textContent='@keyframes spin{to{transform:rotate(360deg)}}';document.head.appendChild(s);}());

    const loadingEl = document.getElementById('loading');
    const errorEl   = document.getElementById('error');
    const cardsEl   = document.getElementById('cards');
    const analysisEl= document.getElementById('analysis');
    const rationaleWrap = document.getElementById('rationale-wrap');

    const assetTitle = document.getElementById('asset-title');
    const assetAlloc = document.getElementById('asset-alloc');
    const histEl = document.getElementById('hist');
    const indEl  = document.getElementById('indicators');
    const riskEl = document.getElementById('risk');
    const assetExpl = document.getElementById('asset-expl');
    const rationale = document.getElementById('rationale');
    const asof = document.getElementById('asof');

    let lastReco = null;
    try { lastReco = JSON.parse(sessionStorage.getItem('portfolio_lastReco') || 'null'); } catch(e){}

    const statRow = (label, value) =>
      `<div class="row"><span class="muted">${label}</span><span style="font-weight:700">${value}</span></div>`;

    const fmtPct = x => `${(+x).toFixed(2)}%`;
    const titleize = s => s.replace(/_/g,' ').replace(/\b\w/g, c => c.toUpperCase());

    function renderIndicators(km){
      if (!km || Object.keys(km).length === 0) return `<div class="muted">—</div>`;
      const labelMap = {
        global_context: 'Global Context',
        institutional_flows: 'Institutional Flows',
        market_levels: 'Market Levels',
        policy_metrics: 'Policy Metrics',
        sentiment_indicators: 'Sentiment Indicators',
        flow_analysis: 'Flow Analysis',
        funding_metrics: 'Funding Metrics',
        liquidity_data: 'Liquidity',
        price_momentum: 'Price Momentum',
        currency_data: 'Currency',
        yield_analysis: 'Yield Analysis',
        valuation_metrics: 'Valuation Metrics',
        property_fundamentals: 'Property Fundamentals',
        market_activity: 'Market Activity'
      };
      return Object.entries(km).map(([k,v]) => {
        const label = labelMap[k] || titleize(k);
        const val = (v === null || v === undefined) ? '—' : String(v);
        return `<div class="row" style="border-bottom:1px dashed var(--border)">
                  <span class="muted" style="min-width:160px">${label}</span>
                  <span style="font-weight:700">${val}</span>
                </div>`;
      }).join('');
    }

    async function callExplain(payload){
      const resp = await fetch('/explain', {
        method:'POST',
        headers:{'Content-Type':'application/json','Cache-Control':'no-store'},
        body: JSON.stringify(payload)
      });
      let json = null;
      try { json = await resp.json(); } catch(e){}
      return { status: resp.status, body: json };
    }

    async function run() {
      if (!lastReco) {
        loadingEl.classList.add('hidden');
        errorEl.textContent = 'No recent recommendation found. Please go back and click “Explain this allocation”.';
        errorEl.classList.remove('hidden');
        return;
      }
      const basePayload = {
        job_id: lastReco.jobId || null,
        current_weights: lastReco.currentWeights || {},
        final_weights: lastReco.finalWeights || {},
        risk_profile_used: lastReco.profileUsed || 'Balanced'
      };

      let attempts = 0, MAX = 60;
      while (attempts < MAX) {
        attempts++;
        const { status, body } = await callExplain(basePayload);

        if (status === 202 || (body && body.status === 'pending')) {
          await new Promise(r => setTimeout(r, Math.min(2000 + attempts*1500, 7000)));
          continue;
        }

        // stop loading once we have a final answer (success or error)
        loadingEl.classList.add('hidden');

        if (!body || body.status === 'error') {
          errorEl.textContent = (body && (body.message || body.error)) || 'Could not generate explanation.';
          errorEl.classList.remove('hidden');
          return;
        }

        render(body);
        return;
      }

      loadingEl.classList.add('hidden');
      errorEl.textContent = 'Still preparing fresh metrics. Please wait a moment and click Refresh.';
      errorEl.classList.remove('hidden');
    }

    function render(apiResp){
      const pa = apiResp?.explanation?.portfolio_analysis || {};
      const assets = pa.assets || {};
      const order = ["Gold","Equities","REITs","Bitcoin"].filter(a => assets[a]);

      const ts = apiResp?.metadata?.timestamp || null;
      if (ts) asof.textContent = `As of ${ts}`;

      // Cards with ▲/▼ delta
      cardsEl.innerHTML = order.map(a => {
        const rec = assets[a]?.allocation_pct ?? (lastReco.finalWeights?.[a] ?? 0);
        const cur = lastReco.currentWeights?.[a] ?? 0;
        const delta = (+rec) - (+cur);
        const up = delta > 0;
        const arrow = up ? '▲' : (delta < 0 ? '▼' : '—');
        const clr = up ? '#34d399' : (delta<0 ? '#f87171' : '#94a3b8');
        return `
          <button data-asset="${a}" class="tile" style="text-align:left">
            <div class="row" style="border-bottom:0">
              <div class="title">${a}</div>
              <div style="font-weight:700;color:${clr}">${arrow} ${delta===0? '0.00' : Math.abs(delta).toFixed(2)} pp</div>
            </div>
            <div class="title" style="font-size:28px">${fmtPct(rec)}</div>
            <div class="muted" style="font-size:13px">Recommended allocation</div>
            <div class="tile" style="text-align:center;margin-top:10px">View Details</div>
          </button>`;
      }).join('');

      cardsEl.classList.remove('hidden');

      if (order.length) showAsset(order[0], assets);
      rationale.textContent = pa.allocation_rationale || '—';
      rationaleWrap.classList.remove('hidden');

      // clicking a card switches the right-hand analysis
      cardsEl.querySelectorAll('button[data-asset]').forEach(btn => {
        btn.addEventListener('click', () => showAsset(btn.dataset.asset, assets));
      });
    }

    function showAsset(a, assets) {
      const node = assets[a] || {};
      assetTitle.textContent = a;
      const rec = node.allocation_pct ?? (lastReco.finalWeights?.[a] ?? 0);
      assetAlloc.textContent = fmtPct(rec);

      const hr = node.historical_returns || {};
      histEl.innerHTML =
        (hr["1_year"]       ? statRow("1 Year", hr["1_year"]) : "") +
        (hr["5_years_avg"]  ? statRow("5 Years (Avg)", hr["5_years_avg"]) : "") +
        (hr["10_years_avg"] ? statRow("10 Years (Avg)", hr["10_years_avg"]) : "") ||
        `<div class="muted">—</div>`;

      const km = node.key_market_data || {};
      indEl.innerHTML = renderIndicators(km);

      const rm = node.risk_metrics || {};
      riskEl.innerHTML =
        (rm["volatility"]   ? statRow("Volatility", rm["volatility"]) : "") +
        (rm["max_drawdown"] ? statRow("Max Drawdown", rm["max_drawdown"]) : "") +
        (rm["sharpe_ratio"] ? statRow("Sharpe Ratio", rm["sharpe_ratio"]) : "") +
        (rm["var_95"]       ? statRow("VaR (95%)", rm["var_95"]) : "") ||
        `<div class="muted">—</div>`;

      assetExpl.textContent = node.explanation || '—';
      analysisEl.classList.remove('hidden');
    }

    run();
  </script>
</body>
</html>
